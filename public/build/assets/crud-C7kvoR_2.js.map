{"version":3,"file":"crud-C7kvoR_2.js","sources":["../../../resources/js/services/crud.js"],"sourcesContent":["import _axios from '@/plugins/axios'; \r\nimport { filterObject, isObject } from '@/libs/util';\r\n\r\nclass CrudService {\r\n  constructor(\r\n    name,\r\n    endpoint,\r\n    methods=['index', 'fetch', 'show', 'get', 'store', 'create', 'put', 'patch', 'update', 'destroy', 'delete'],\r\n    fields=[],\r\n    files=[],\r\n    setters=true,\r\n    updateMethod='patch',\r\n    axios=null,\r\n  ){\r\n    this.axios = axios || _axios;\r\n    this.name = name;\r\n    this.endpoint = endpoint;\r\n    this.methods = methods;\r\n    this.fields = fields;\r\n    this.files = files;\r\n    this.updateMethod = updateMethod;\r\n    const allowSetters = this.methods.filter(m => ['update', 'patch'].includes(m));\r\n    if (allowSetters && this.allFields.length > 0){\r\n      if (\r\n        (setters === true) \r\n        // || (Array.isArray(setters) && setters.length == 0)\r\n      ){\r\n        setters = this.allFields;\r\n      }\r\n    }else{\r\n      setters = null;\r\n    }\r\n    if (Array.isArray(setters) && setters.length > 0){\r\n      this.createSetters(setters);\r\n    }\r\n  }\r\n\r\n  get allFields(){\r\n    return [...this.fields, ...this.files];\r\n  }\r\n  \r\n  createSetters(setters){\r\n    this.setters = setters;\r\n    for (const field of this.setters) {\r\n        let f = (obj, new_value) => this.set_field(field, obj, new_value);\r\n        this[`set_${field}`] = f;\r\n    }\r\n  }\r\n\r\n  async set_field(field, obj, value){\r\n    return await this.patch(obj, { [field]: value });\r\n  }\r\n\r\n  singleEndpoint(obj){\r\n    obj = obj?.id ?? obj;\r\n    if(obj == null)\r\n      return this.endpoint;\r\n    return `${this.endpoint}/${obj}`;\r\n  }\r\n\r\n  checkMethod(method){\r\n    method = method.toLowerCase();\r\n    if(this.methods.includes(method))\r\n      return true;\r\n    let err = new Error(`Method ${method} not allowed for endpoint ${this.endpoint}`);\r\n    err.show = true;\r\n    err.title = \"Not allowed\";\r\n    throw err;\r\n  }\r\n\r\n  checkFiles(form, files={}){\r\n    if (this.files.length == 0 || !this.files)\r\n      return form;\r\n    \r\n    const formData = new FormData();\r\n    this.fields.forEach((f) => {\r\n      if (f in form){\r\n        formData.append(f, form[f]);\r\n      }\r\n    });\r\n    this.files.forEach((f) => {\r\n      if (f in form && form[f]){\r\n        formData.append(f, form[f]);\r\n        formData._has_files = true;\r\n      }else if (files && f in files && files[f]){\r\n        formData.append(f, files[f]);\r\n        formData._has_files = true;\r\n      }\r\n    });\r\n    return formData;\r\n  }\r\n\r\n  async index(query={}, options={}){\r\n    let res = await axios.get(this.endpoint, options);\r\n    return res.data;\r\n  }\r\n  async fetch(query={}){\r\n    return await this.index(query);\r\n  }\r\n\r\n  async get(obj, options={}){\r\n    let res = await axios.get(this.singleEndpoint(obj), options);\r\n    return res.data;\r\n  }\r\n  async show(obj){\r\n    return await this.get(obj);\r\n  }\r\n\r\n  getData(data){\r\n    if (!data)\r\n      return null;\r\n    return data?.data ?? data?.[this.name.toLowerCase()] ?? data?.[`${this.name.toLowerCase()}s`];\r\n  }\r\n\r\n  async post(form, options={}){\r\n    form = filterObject(form, this.fields);\r\n    let res = await axios.post(this.endpoint, form, options);\r\n    return res.data;\r\n  }\r\n  async create(form){\r\n    return await this.post(form);\r\n  }\r\n  async store(form){\r\n    return await this.post(form);\r\n  }\r\n\r\n  async call(obj, form={}, files={}, method='put'){\r\n    // this.checkMethod(method);\r\n    let obj0 = obj;\r\n    obj = obj?.id ?? obj;\r\n    let hasFiles = false;\r\n    if (form){\r\n      form = filterObject(form, this.allFields);\r\n      console.log(form);\r\n      form = this.checkFiles(form, files);\r\n      console.log(form);\r\n      hasFiles = form._has_files;\r\n    }\r\n    let res = null;\r\n    let target = this.singleEndpoint(obj);\r\n    let data = form;\r\n    if ([this.updateMethod, 'update'].includes(method.toLowerCase())){\r\n      method = this.updateMethod.toUpperCase();\r\n    }\r\n    if (['delete', 'destroy'].includes(method.toLowerCase())){\r\n      data = {\r\n        data: data\r\n      };\r\n      method = 'DELETE';\r\n    }\r\n    let f = this.axios[method.toLowerCase()];\r\n    let options = {};\r\n    if (hasFiles){\r\n      options = {\r\n        ...options,\r\n        headers: { \"Content-Type\": \"multipart/form-data\" },\r\n        params: {\r\n          // Laravel won't process multipart/form-data in a PUT request\r\n          // So we send a POST request but spoof it\r\n          _method: method.toUpperCase(), \r\n        },\r\n      };\r\n      f = this.axios.post;\r\n    }\r\n    res = await f(target, data, options);\r\n    if (isObject(obj0)){\r\n      let data = this.getData(res);\r\n      if (data){\r\n        Object.assign(obj0, this.getData(res.data));\r\n      }\r\n    }\r\n    return res.data;\r\n  }\r\n\r\n  async put(obj, form={}, files={}){\r\n    return await this.call(obj, form, files, 'put');\r\n  }\r\n  async patch(obj, form={}, files={}){\r\n    return await this.call(obj, form, files, 'patch');\r\n  }\r\n  async update(obj, form={}, files={}){\r\n    return await this.call(obj, form, files, this.updateMethod);\r\n  }\r\n  async delete(obj, form={}, files={}){\r\n    await this.call(obj, form, files, 'destroy');\r\n  }\r\n  async destroy(obj, form={}, files={}){\r\n    return await this.delete(obj, form, files);\r\n  }\r\n}\r\n\r\nexport { CrudService };\r\nexport default CrudService;\r\n"],"names":["axios","_axios","data"],"mappings":"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"}